<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>In-App Navigation Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    .userDot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #2e7df6;
      border: 2px solid white;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoicmF2ZW5nYW1pbmciLCJhIjoiY2xpbm40OTM0MDBzeTNmcW9ham9ydzhzcCJ9.HWmIx6GwDBWAAtpZHLuKQA'; // <- Replace this!

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v12',
      center: [-0.1, 51.5],
      zoom: 13
    });

    let userMarker;
    let routeSourceAdded = false;

    // Move the user's blue dot
    window.setUserPos = function(lat, lng, bearing) {
      if (!userMarker) {
        const el = document.createElement('div');
        el.className = 'userDot';
        userMarker = new mapboxgl.Marker(el).setLngLat([lng, lat]).addTo(map);
      } else {
        userMarker.setLngLat([lng, lat]);
      }
      map.easeTo({ center: [lng, lat], bearing: bearing || 0, duration: 500 });
    };

    // Draw the route line
    window.setRoute = function(routeGeoJSONString) {
      const routeGeoJSON = JSON.parse(routeGeoJSONString);
      if (!routeSourceAdded) {
        map.on('load', () => {
          map.addSource('route', { type: 'geojson', data: routeGeoJSON });
          map.addLayer({
            id: 'route-line',
            type: 'line',
            source: 'route',
            paint: {
              'line-width': 5,
              'line-color': '#0078ff'
            }
          });
          routeSourceAdded = true;
          fitToRoute(routeGeoJSON);
        });
      } else {
        const source = map.getSource('route');
        if (source) {
          source.setData(routeGeoJSON);
          fitToRoute(routeGeoJSON);
        }
      }
    };

    function fitToRoute(geojson) {
      try {
        const coords = geojson.geometry.coordinates;
        const bounds = new mapboxgl.LngLatBounds(coords[0], coords[0]);
        for (const c of coords) bounds.extend(c);
        map.fitBounds(bounds, { padding: 60, duration: 700 });
      } catch (e) {
        console.warn("Route fit failed", e);
      }
    }
  </script>
</body>
</html>
